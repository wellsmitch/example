<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Title</title>
    <script src="../js/jquery.js"></script>
</head>
<body>
<img src="" alt="">
<script type="text/javascript">
	var ungStr = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAFA3PEY8MlBGQUZaVVBfeMiCeG5uePWvuZHI////////////////////////////////////////////////////2wBDAVVaWnhpeOuCguv/////////////////////////////////////////////////////////////////////////wAARCACxARcDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAECAwT/xAAtEAACAgEDBAIBAgcBAQAAAAAAAQIRIRIxQQNRYXEygSITkQQjM0KhscHw8f/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAZEQEBAQEBAQAAAAAAAAAAAAAAARExAhL/2gAMAwEAAhEDEQA/AM7GmKgorKrHZNBjgCgEKwKsLJTGA7HqfdkgUUpNbNmsOs1iWfJiGxB2pp7DOOE3B2jfp9VTdbMi61AACgAAAIm9KssmUdQHJ1K13wyJpxknmuLN+r0PxuOfZkrnhlRfTmlHtaOiHxXk5WpVXH+jo6UrVAaAAEUCbpdyZTUd2Y9TrX4CNJdRrfD7IjWkmm2/CMZdS3e/shysC5zV/wDmS50+P9kNibAqUnLcl+RWFdwDHkAoANa7BmwQ8oqAQw5AWR2DDABgEAWAwFYWAxi9AAwECYGsOtKO+Uax60W6ePZzAB2p2M44zlHZs1h11/d+4xdbgJNNWhkUnsc04U3KP2dJh1Hp6iaVrlBGVrSu/J0Qaj09VXgwelNt1VhL+IxUcIo2/Xj2Zl1Ou9VLkzUtSk2ZWBpKUubRDYm2xUQGoLYq8hnuA67hQs+BZAoVisLAYCADS2ilfkTryDwVDoKz4BPAbvADvgBVwJvPgCgEgzuA8B6FsPcBDt8CoAHY1chRV7lXQDpUTbDfkQFZAV97+havEv3Lgv8AUccJsUv4ifevREnHmP8AkUYxb53wRVfq9R7Sa+xa3WZZ7ldTopRu3+5m4+WMNDd92LL7IpRbaV/4G+lNvdDgI46ciL7ItJrpvYmnzF/TGCciG93hr2IgBZDIqALAAAdgIYAAABsk92CTHn/4K/YQNCoeRoCa7MbVg6eMmkFFRt02UZ15Cy212QtKIqbHdlJIdLlBE2Iq12svRFwtYCsttrQWW4tLCbJp57gTqY1T8k0x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"
    //压缩方法
    function dealImage(base64, w, callback) {
        var newImage = new Image();
        var quality = 0.1;    //压缩系数0-1之间
        newImage.src = base64;
        newImage.setAttribute("crossOrigin", 'Anonymous');	//url为外域时需要
        var imgWidth, imgHeight;
        newImage.onload = function () {
            imgWidth = this.width;
            imgHeight = this.height;
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            if (Math.max(imgWidth, imgHeight) > w) {
                if (imgWidth > imgHeight) {
                    canvas.width = w;
                    canvas.height = w * imgHeight / imgWidth;
                } else {
                    canvas.height = w;
                    canvas.width = w * imgWidth / imgHeight;
                }
            } else {
                canvas.width = imgWidth;
                canvas.height = imgHeight;
                quality = 0.6;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(this, 0, 0, canvas.width, canvas.height);
            var base64 = canvas.toDataURL("image/jpeg", quality); //压缩语句
            // 如想确保图片压缩到自己想要的尺寸,如要求在50-150kb之间，请加以下语句，quality初始值根据情况自定
            while (base64.length / 1024 > 150) {
            	quality -= 0.01;
            	base64 = canvas.toDataURL("image/jpeg", quality);
            }
            // 防止最后一次压缩低于最低尺寸，只要quality递减合理，无需考虑
            // while (base64.length / 1024 < 50) {
            // 	quality += 0.001;
            // 	base64 = canvas.toDataURL("image/jpeg", quality);
            // }
            callback(base64);//必须通过回调函数返回，否则无法及时拿到该值
        }
    }
    //这是原来的base64格式字符串
    var base64= ungStr;
    //这就是你压缩之后的字符串
    var str;
    //你可以打桩看一下有多长
    console.log("原来的长度",base64.length);
    //然后调用压缩方法 第一个参数就是原来的字符串，第二个是宽度，第三个就是回调方法，也就是压缩函数最后面那个callback（base64）
    dealImage(base64, 80, useImg);
    //然后一压 再打个桩看下长度 方法名随便起怎么舒服怎么来
    function useImg(base64) {
        str= base64;
        $("img").attr("src",str);
        console.log("压缩后的长度",str.length);
    }



</script>
</body>
</html>
